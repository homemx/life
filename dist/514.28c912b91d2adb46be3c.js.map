{"version":3,"file":"514.28c912b91d2adb46be3c.js","mappings":"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","sources":["webpack://template-react-base/./src/page/example/user/index.jsx","webpack://template-react-base/./src/util/type.js","webpack://template-react-base/./src/util/request.js","webpack://template-react-base/./src/config/request.js","webpack://template-react-base/./src/page/example/user/service.js"],"sourcesContent":["import React from 'react'\nimport { Redirect } from 'react-router-dom'\nimport { Switch, AsyncRoute } from '@/util/route'\nimport { getUser } from './service'\n\nexport default function Router() {\n  return (\n    <Switch>\n      <AsyncRoute path=\"/user\" exact module={() => import('./list')} />\n      <AsyncRoute\n        path=\"/user/:id\"\n        permission={async ({ computedMatch }) => {\n          const { id } = computedMatch?.params\n          if (id === '100') {\n            const user = await getUser('globalLoading')\n            return (\n              <Redirect to={{\n                pathname: '/about',\n                search: `?id=${id}&name=${user.name}`\n              }}\n              />\n            )\n          }\n          return true\n        }}\n        module={() => import('./detail')}\n      />\n    </Switch>\n  )\n}\n","export function isFunction(v) {\n  return typeof v === 'function'\n}\n","import axios from 'axios'\nimport queryString from 'query-string'\nimport { isFunction } from './type'\n\nconst STATUS = {\n  pending: 1,\n  finish: 2,\n  error: 3\n}\n\nexport default class Request {\n  static create(config) {\n    const cache = {}\n    const instance = axios.create({\n      withCredentials: true,\n      loadingTime: 1500,\n      shouldBlock(error) {\n        const status = error?.response?.status\n        return status === 429 || status === 503\n      },\n      block(_c) {\n        return true\n      },\n      blockTime: 10 * 60 * 1000,\n      shouldRetry(error) {\n        return error?.response?.status >= 500\n      },\n      ...config\n    })\n\n    const originRequest = instance.request.bind(instance)\n    let blockRequest = false\n    let blockError = null\n\n    const handleError = (error, c) => {\n      // failover 对于一个请求只允许进行一次\n      if (isFunction(c.failover)) {\n        const newConfig = c.failover(error, c)\n        if (typeof newConfig === 'object') {\n          return instance.request({\n            ...newConfig,\n            failover: false\n          })\n        }\n      }\n\n      if (isFunction(c.shouldBlock)) {\n        blockRequest = c.shouldBlock(error)\n        blockError = error\n        setTimeout(() => {\n          blockRequest = false\n          blockError = null\n        }, c.blockTime)\n      }\n\n      if (c.retry > 0 && c._retry < Math.min(c.retry, 2)) {\n        if (c.shouldRetry(error)) {\n          c._retry += 1\n          return instance.request(c)\n        }\n      }\n      if (isFunction(c.error)) {\n        c.error(error, c)\n      }\n      return Promise.reject(error)\n    }\n\n    const getKey = ({ key, params, url }) => {\n      if (key) {\n        return key\n      }\n      const query = queryString.stringify(params)\n      const _key = `${url}${query ?? `?${query}`}`\n      return _key\n    }\n\n    const clearLoadingTimer = (key) => {\n      if (cache[key]) {\n        const { timer } = cache[key]\n        if (timer) {\n          clearTimeout(timer)\n        }\n      }\n    }\n\n    instance.request = function request(c) {\n      const key = getKey(c)\n      const exist = cache[key]\n      if (exist) {\n        // 同 url 请求还在等待的直接返回，不发起请求\n        if (exist.status === STATUS.pending) {\n          return Promise.resolve({})\n        }\n        // get 请求支持缓存\n        if (c.method === 'get') {\n          // 强制请求，直接发起，忽略缓存情况\n          if (c.force) {\n            return originRequest(c)\n          }\n          // 存在缓存数据，直接使用\n          if (cache[key].response) {\n            return Promise.resolve(cache[key].response)\n          }\n        }\n      }\n\n      return originRequest(c)\n    }\n\n    {\n      const actions = ['delete', 'get', 'head', 'options']\n      actions.forEach((method) => {\n        instance[method] = function request(url, c) {\n          return instance.request({\n            ...c,\n            method,\n            url,\n            data: (c || {}).data\n          })\n        }\n      })\n    }\n\n    {\n      const actions = ['post', 'put', 'patch']\n      actions.forEach((method) => {\n        instance[method] = function request(url, data, c) {\n          return instance.request({\n            ...c,\n            method,\n            url,\n            data\n          })\n        }\n      })\n    }\n\n    instance.interceptors.request.use(\n      (c) => {\n        const { loading, loadingTime } = c\n        if (blockRequest && c.block(c)) {\n          return Promise.reject(blockError)\n        }\n        const key = getKey(c)\n        c.key = key\n        c._retry = c._retry ?? 0\n        cache[key] = Object.assign(cache[key] || {}, {\n          status: STATUS.pending,\n          timer: setTimeout(() => {\n            if (isFunction(loading)) {\n              loading(c)\n            }\n          }, loadingTime)\n        })\n        return c\n      },\n      (error) => handleError(error, error.config)\n    )\n\n    instance.interceptors.response.use(\n      (response) => {\n        const c = response.config\n        const { ttl, method, key } = c\n        clearLoadingTimer(key)\n        cache[key].status = STATUS.finish\n\n        if (method.toLocaleLowerCase() === 'get' && ttl > 0) {\n          cache[key].response = response\n          if (cache[key].clearCacheTimer) {\n            clearTimeout(cache[key].clearCacheTimer)\n          }\n          cache[key].clearCacheTimer = setTimeout(() => {\n            delete cache[key]\n          }, ttl)\n        } else {\n          delete cache[key]\n        }\n\n        if (isFunction(config.complete)) {\n          config.complete(c)\n        }\n        return response\n      },\n      (error) => {\n        const { key } = error.config\n        if (key) {\n          clearLoadingTimer(key)\n          if (cache[key]) {\n            cache[key].status = STATUS.error\n            delete cache[key]\n          }\n        }\n        if (isFunction(config.complete)) {\n          config.complete(error.config)\n        }\n        return handleError(error, error.config)\n      }\n    )\n\n    instance.clear = function clear(url) {\n      if (url) {\n        const item = cache[url]\n        if (item && item.status !== STATUS.pending) {\n          delete cache[url]\n        }\n      } else {\n        Object.keys(cache).forEach((key) => {\n          const item = cache[key]\n          if (item && item.status !== STATUS.pending) {\n            delete cache[key]\n          }\n        })\n      }\n    }\n\n    return instance\n  }\n}\n","import Request from '@/util/request'\n\nexport const api = Request.create({\n  baseURL: {\n    local: '//localhost:9300',\n    production: '//mock.gem-mine.tech/mock/272'\n  }[process.env.NODE_ENV],\n  loading() {\n    console.log('global  loading...')\n  },\n  failover(_e, c) {\n    if (c.url === '/user/200') {\n      c.baseURL = '//mock.gem-mine.tech/mock/272'\n      return c\n    }\n  },\n  error(e) {\n    const message = e?.response?.data?.message ?? e?.message ?? '未知异常'\n    console.log('global error', message)\n  }\n})\n","import { api } from '@/config/request'\n\nconst branch = {\n  normal: () => ([1, {}]),\n  globalLoading: () => ([2, {\n  // 使用全局 loading\n    params: {\n      _delay: 2500\n    }\n  }]),\n  customLoading: () => ([3, {\n    // 使用自定义 loading\n    params: {\n      _delay: 2500\n    },\n    loading: () => {\n      console.log('custom loading...')\n    }\n  }]),\n  globalError: () => ([4, {\n    // 使用全局错误\n    params: {\n      _error: true\n    }\n  }]),\n  customError: () => ([5, {\n    // 使用自定义错误\n    params: {\n      _error: true\n    },\n    error: (e) => {\n      console.log('custom error', e)\n    }\n  }]),\n  retry: () => ([5, {\n    // 错误重试 2 次\n    params: {\n      _delay: 2000,\n      _error: true\n    },\n    retry: 2\n  }]),\n  cache: () => ([6, {\n    // 使用全局 loading，存活 15000 ms，存活期直接使用数据\n    key: 'xxx',\n    params: {\n      _delay: 2000\n    },\n    ttl: 15000\n  }]),\n  force: () => ([7, {\n    // 不使用缓存，即便缓存还在存活期\n    key: 'xxx',\n    force: true,\n    ttl: 15000\n  }]),\n  block: () => ([8, {\n    // 错误后屏蔽请求\n    params: {\n      _delay: 2000,\n      _error: true,\n      _status: 503\n    }\n  }]),\n  failover: () => ([200, {\n    _error: true\n  }])\n}\n\nexport async function getUser(type) {\n  const [id, config] = branch[type]()\n\n  const { data } = await api.get(`/user/${id}`, config)\n  return data\n}\n"],"names":["Router","path","exact","module","permission","computedMatch","params","id","getUser","user","to","pathname","search","name","isFunction","v","STATUS","api","Request","config","cache","instance","axios","withCredentials","loadingTime","shouldBlock","error","status","response","block","_c","blockTime","shouldRetry","originRequest","request","bind","blockRequest","blockError","handleError","c","failover","newConfig","setTimeout","retry","_retry","Math","min","Promise","reject","getKey","key","url","query","queryString","clearLoadingTimer","timer","clearTimeout","exist","resolve","method","force","forEach","data","interceptors","use","loading","Object","assign","ttl","toLocaleLowerCase","clearCacheTimer","complete","clear","item","keys","create","baseURL","console","log","_e","e","message","branch","normal","globalLoading","_delay","customLoading","globalError","_error","customError","_status","type","get"],"sourceRoot":""}